{% extends 'base.html' %}
{% load static %}

{% block title %}Техническая поддержка - MPTCOURSE{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<link rel="stylesheet" href="{% static 'css/support.css' %}">
{% endblock %}

{% block content %}
<div class="support-page">
    <h1 class="support-title">Техническая поддержка</h1>
    
    <!-- Форма создания обращения -->
    <div class="support-form-container">
        <h2>Создать обращение</h2>
        <form id="supportForm" onsubmit="createTicket(event)">
            <div class="form-group">
                <label for="ticketSubject">Тема обращения:</label>
                <input type="text" id="ticketSubject" name="subject" required placeholder="Опишите проблему кратко">
            </div>
            
            <div class="form-group">
                <label for="ticketMessage">Сообщение:</label>
                <textarea id="ticketMessage" name="message_text" rows="6" required placeholder="Опишите вашу проблему подробно..."></textarea>
            </div>
            
            <button type="submit" class="btn-submit">Отправить обращение</button>
        </form>
    </div>
    
    <!-- История обращений (загрузка через API) -->
    <div class="tickets-container">
        <h2>Мои обращения</h2>
        <div id="tickets-loading">Загрузка обращений...</div>
        <div class="tickets-list" id="tickets-list" style="display: none;"></div>
        <p class="no-tickets" id="tickets-empty" style="display: none;">У вас пока нет обращений в поддержку</p>
    </div>
</div>

<script>
(function loadTickets() {
    var loading = document.getElementById('tickets-loading');
    var listEl = document.getElementById('tickets-list');
    var empty = document.getElementById('tickets-empty');
    if (!loading || !listEl) return;
    fetch('/api/support/', { method: 'GET', credentials: 'same-origin' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            loading.style.display = 'none';
            var tickets = Array.isArray(data) ? data : (data.tickets || data.results || []);
            if (tickets.length === 0) {
                empty.style.display = 'block';
                return;
            }
            listEl.style.display = 'block';
            listEl.innerHTML = '';
            tickets.forEach(function(t) {
                var created = t.created_at ? new Date(t.created_at).toLocaleString('ru-RU') : '';
                var status = t.ticket_status || t.status || '';
                var statusLabel = status === 'new' ? 'Новое' : status === 'in_progress' ? 'В работе' : status === 'closed' ? 'Закрыто' : status;
                var msg = (t.message_text || '').substring(0, 100);
                if ((t.message_text || '').length > 100) msg += '...';
                var html = '<div class="ticket-item"><div class="ticket-header"><div class="ticket-info"><h3 class="ticket-subject">' + (t.subject || '').replace(/</g, '&lt;') + '</h3><span class="ticket-date">' + created + '</span></div><span class="ticket-status status-' + status + '">' + statusLabel + '</span></div><div class="ticket-message"><p>' + msg.replace(/</g, '&lt;') + '</p></div>';
                if (t.response_text) html += '<div class="ticket-response"><strong>Ответ поддержки:</strong><p>' + (t.response_text || '').replace(/</g, '&lt;') + '</p></div>';
                html += '<a href="/support/' + t.id + '/" class="btn-view">Подробнее</a></div>';
                listEl.insertAdjacentHTML('beforeend', html);
            });
        })
        .catch(function() {
            loading.textContent = 'Ошибка загрузки обращений';
        });
})();
function createTicket(event) {
    event.preventDefault();
    
    const subject = document.getElementById("ticketSubject").value.trim();
    const message = document.getElementById("ticketMessage").value.trim();
    
    if (!subject || !message) {
        alert("Пожалуйста, заполните все поля");
        return;
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if(document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for(let cookie of cookies){
                cookie = cookie.trim();
                if(cookie.startsWith(name + '=')){
                    cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                    break;
                }
            }
        }
        if(!cookieValue){
            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if(csrfInput) cookieValue = csrfInput.value;
        }
        return cookieValue;
    }
    
    fetch("/api/support/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie('csrftoken')
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            subject: subject,
            message_text: message
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert("Обращение создано! Мы свяжемся с вами в ближайшее время.");
            document.getElementById("supportForm").reset();
            location.reload();
        } else {
            alert("Ошибка: " + (data.error || data.message || "Не удалось создать обращение"));
        }
    })
    .catch(() => alert("Ошибка при отправке обращения"));
}
</script>
{% endblock %}

