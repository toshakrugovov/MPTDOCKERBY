{% extends 'base.html' %}
{% load static %}

{% block title %}–ú–æ–∏ –∫—É—Ä—Å—ã - MPTCOURSE{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
<link rel="stylesheet" href="{% static 'css/catalog.css' %}">
<link rel="stylesheet" href="{% static 'css/my_courses.css' %}">
{% endblock %}

{% block content %}
<div class="profile-content">
    <div class="my-courses-page">
        <header class="my-courses-header">
            <a href="{% url 'profile' %}" class="my-courses-back">‚Üê –í –ø—Ä–æ—Ñ–∏–ª—å</a>
            <h1 class="my-courses-title">–ú–æ–∏ –∫—É—Ä—Å—ã</h1>
        </header>

        <div id="my-courses-loading" class="my-courses-loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–æ–≤...</div>

        <div id="my-courses-content" style="display: none;">
            <section class="my-courses-section actual">
                <div class="my-courses-section-card">
                    <h2 class="my-courses-section-title"><span class="section-dot"></span>–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ</h2>
                    <div class="products-grid" id="my-courses-actual"></div>
                    <div class="my-courses-empty" id="actual-empty" style="display: none;">
                        <div class="my-courses-empty-icon">üìö</div>
                        <p class="my-courses-empty-text">–ù–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∫—É—Ä—Å–æ–≤</p>
                        <p class="my-courses-empty-hint">–ö—É–ø–∏—Ç–µ –∫—É—Ä—Å –≤ –∫–∞—Ç–∞–ª–æ–≥–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ.</p>
                        <a href="{% url 'catalog' %}">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥</a>
                    </div>
                </div>
            </section>

            <section class="my-courses-section refund" id="refund-pending-section">
                <div class="my-courses-section-card">
                    <h2 class="my-courses-section-title"><span class="section-dot"></span>–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞</h2>
                    <p class="my-courses-section-desc">–ó–∞—è–≤–ª–µ–Ω–∏–µ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç –ø–æ —ç—Ç–∏–º –∫—É—Ä—Å–∞–º —É–∂–µ –ø–æ–¥–∞–Ω–æ. –ö—É—Ä—Å—ã –±—É–¥—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–æ —Ä–µ—à–µ–Ω–∏—è.</p>
                    <div class="products-grid" id="my-courses-refund-pending"></div>
                </div>
            </section>

            <section class="my-courses-section archived">
                <div class="my-courses-section-card">
                    <h2 class="my-courses-section-title"><span class="section-dot"></span>–ê—Ä—Ö–∏–≤–Ω—ã–µ</h2>
                    <div class="products-grid" id="my-courses-archived"></div>
                    <div class="my-courses-empty" id="archived-empty" style="display: none;">
                        <div class="my-courses-empty-icon">‚úì</div>
                        <p class="my-courses-empty-text">–ù–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤</p>
                        <p class="my-courses-empty-hint">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∫—É—Ä—Å—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.</p>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>
<script>
(function() {
    var loading = document.getElementById('my-courses-loading');
    var content = document.getElementById('my-courses-content');
    var baseUrl = "{% url 'profile' %}".replace(/\/$/, '') + '/my-courses/';
    var catalogUrl = "{% url 'catalog' %}";
    fetch('/api/my-courses/', { method: 'GET', credentials: 'same-origin' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (!loading || !content) return;
            loading.style.display = 'none';
            content.style.display = 'block';
            function renderCard(p, opts) {
                var img = (p.course && p.course.cover_image_path) || '';
                var title = (p.course && p.course.title) || '–ö—É—Ä—Å';
                var url = baseUrl + p.id + '/';
                if (opts && opts.refundPending) {
                    return '<div class="product-card" style="opacity: 0.85; cursor: default; pointer-events: none;">' +
                        '<div class="product-image">' + (img ? '<img src="' + img + '" alt="' + title.replace(/"/g, '&quot;') + '">' : '<div style="padding: 40px; background: var(--border-color); color: var(--text-color-secondary);">–ö—É—Ä—Å</div>') + '</div>' +
                        '<div class="product-info"><h3 class="product-name">' + title.replace(/</g, '&lt;') + '</h3><div class="product-price">–í–æ–∑–≤—Ä–∞—Ç –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏ ‚Ä¢ –ö—É—Ä—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div></div></div>';
                }
                if (opts && opts.archived) {
                    var completed = p.completed_at ? new Date(p.completed_at).toLocaleDateString('ru-RU') : '';
                    return '<a href="' + url + '" class="product-card" style="text-decoration: none; color: inherit;">' +
                        '<div class="product-image">' + (img ? '<img src="' + img + '" alt="' + title.replace(/"/g, '&quot;') + '">' : '<div style="padding: 40px; background: var(--border-color); color: var(--text-color-secondary);">–ö—É—Ä—Å</div>') + '</div>' +
                        '<div class="product-info"><h3 class="product-name">' + title.replace(/</g, '&lt;') + '</h3><div class="product-price">–ó–∞–≤–µ—Ä—à—ë–Ω ' + completed + '</div></div></a>';
                }
                return '<div class="product-card" style="display: flex; flex-direction: column;">' +
                    '<a href="' + url + '" style="text-decoration: none; color: inherit; flex: 1; display: flex; flex-direction: column;">' +
                    '<div class="product-image">' + (img ? '<img src="' + img + '" alt="' + title.replace(/"/g, '&quot;') + '">' : '<div style="padding: 40px; background: var(--border-color); color: var(--text-color-secondary);">–ö—É—Ä—Å</div>') + '</div>' +
                    '<div class="product-info"><h3 class="product-name">' + title.replace(/</g, '&lt;') + '</h3></div></a>' +
                    '<a href="' + url + '" class="btn btn-primary btn-course-open" style="margin-top: 12px;">–û—Ç–∫—Ä—ã—Ç—å –∫—É—Ä—Å</a></div>';
            }
            var actual = (data.actual || []);
            var refundPending = (data.refund_pending || []);
            var archived = (data.archived || []);
            var actualEl = document.getElementById('my-courses-actual');
            var actualEmpty = document.getElementById('actual-empty');
            if (actualEl) {
                if (actual.length === 0) { actualEmpty.style.display = 'block'; }
                else { actual.forEach(function(p) { actualEl.insertAdjacentHTML('beforeend', renderCard(p)); }); }
            }
            var refundSection = document.getElementById('refund-pending-section');
            if (refundSection) refundSection.style.display = refundPending.length ? 'block' : 'none';
            var refundEl = document.getElementById('my-courses-refund-pending');
            if (refundEl) refundPending.forEach(function(p) { refundEl.insertAdjacentHTML('beforeend', renderCard(p, { refundPending: true })); });
            var archivedEl = document.getElementById('my-courses-archived');
            var archivedEmpty = document.getElementById('archived-empty');
            if (archivedEl) {
                if (archived.length === 0) { if (archivedEmpty) archivedEmpty.style.display = 'block'; }
                else { archived.forEach(function(p) { archivedEl.insertAdjacentHTML('beforeend', renderCard(p, { archived: true })); }); }
            }
        })
        .catch(function() {
            if (loading) loading.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            if (content) content.style.display = 'block';
        });
})();
</script>
{% endblock %}
