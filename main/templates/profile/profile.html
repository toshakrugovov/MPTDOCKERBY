{% extends 'base.html' %}
{% load static %}

{% block title %}Профиль - MPTCOURSE{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="profile-content">
    <div class="profile-container">
        <div class="profile-left">
            <div class="profile-block-card">
                <div id="profile-loading">Загрузка профиля...</div>
                <div id="profile-block" style="display: none;">
                    <div class="profile-block-header">
                        <h2 id="profile-name" class="profile-block-title"></h2>
                        <a href="{% url 'edit_profile' %}" class="profile-edit-fab" aria-label="Редактировать профиль">
                            <span class="profile-edit-icon" aria-hidden="true">
                                ✎
                            </span>
                        </a>
                    </div>
                    <div class="profile-info" id="profile-info"></div>
                </div>
            </div>
            <div class="profile-nav-block">
                <h3 class="profile-nav-title">Курсы</h3>
                <div class="profile-buttons">
                    <a href="{% url 'my_courses' %}" class="btn">Мои курсы</a>
                </div>
            </div>
        </div>
        <div class="profile-right">
            <div class="profile-nav-block">
                <h3 class="profile-nav-title">Баланс и платежи</h3>
                <div class="profile-buttons">
                    <a href="{% url 'balance' %}" class="btn">Мой баланс</a>
                    <a href="{% url 'order_history' %}" class="btn">Мои заказы</a>
                    <a href="{% url 'receipts_list' %}" class="btn">Мои чеки</a>
                    <a href="{% url 'refund_requests_list' %}" class="btn">Мои заявления на возврат</a>
                </div>
            </div>
            <div class="profile-nav-block">
                <h3 class="profile-nav-title">Аккаунт</h3>
                <div class="profile-buttons">
                    <a href="{% url 'payment_methods' %}" class="btn">Мои способы оплаты</a>
                    <a href="{% url 'support' %}" class="btn">Техническая поддержка</a>
                    <a href="{% url 'admin_dashboard' %}" class="btn" id="profile-admin-btn" style="display: none;">Панель администратора</a>
                    <a href="{% url 'manager_dashboard' %}" class="btn" id="profile-manager-btn" style="display: none;">Панель менеджера</a>
                </div>
                <div class="profile-actions">
                    <form method="post" action="{% url 'logout' %}" class="profile-action-form">
                        {% csrf_token %}
                        <button type="submit" class="btn">Выйти</button>
                    </form>
                    <form method="post" action="{% url 'delete_account' %}" class="profile-action-form"
                          onsubmit="return confirm('Вы уверены, что хотите удалить аккаунт? Это действие нельзя отменить.')">
                        {% csrf_token %}
                        <button type="submit" class="btn danger">Удалить аккаунт</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% if notifications %}
<div class="profile-notifications" id="notifications-panel" data-user-id="{{ request.user.id }}">
    <div class="profile-notifications-header">
        <span>Уведомления</span>
        <button type="button" id="notifications-close" class="notifications-close-btn" aria-label="Закрыть">✕</button>
    </div>
    <div class="profile-notifications-list" id="notifications-list">
        {% for n in notifications %}
        <div class="notification-item" data-id="{{ n.id }}">
            <div>{{ n.text }}</div>
            <div></div>
        </div>
        {% endfor %}
    </div>
</div>
<button type="button" class="notifications-bell" id="notifications-bell" aria-label="Открыть уведомления" title="Открыть уведомления">
    <svg viewBox="0 0 24 24" fill="none">
        <path d="M18 8a6 6 0 10-12 0c0 7-3 7-3 7h18s-3 0-3-7z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M13.73 21a2 2 0 01-3.46 0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
</button>
{% endif %}

<script>
(function loadProfile() {
    var loading = document.getElementById('profile-loading');
    var block = document.getElementById('profile-block');
    if (!loading || !block) return;
    fetch('/api/profile/', { method: 'GET', credentials: 'same-origin' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            loading.style.display = 'none';
            block.style.display = 'block';
            var nameEl = document.getElementById('profile-name');
            var infoEl = document.getElementById('profile-info');
            if (nameEl) nameEl.textContent = data.full_name || data.email || 'Профиль';
            if (infoEl) {
                var parts = [];
                parts.push('<p><strong>ФИО:</strong> ' + (data.full_name ? (data.full_name) : '<span style="color: var(--text-color-secondary);">Не указано</span> <a href="{% url 'edit_profile' %}">Указать</a>') + '</p>');
                if (data.email) parts.push('<p><strong>Email:</strong> ' + data.email + '</p>');
                if (data.phone_number) parts.push('<p><strong>Телефон:</strong> ' + data.phone_number + '</p>');
                if (data.birth_date) {
                    var d = data.birth_date;
                    if (d.indexOf('T') !== -1) d = d.split('T')[0];
                    parts.push('<p><strong>Дата рождения:</strong> ' + d + '</p>');
                }
                infoEl.innerHTML = parts.join('');
            }
            var adminBtn = document.getElementById('profile-admin-btn');
            var managerBtn = document.getElementById('profile-manager-btn');
            if (adminBtn) adminBtn.style.display = data.show_admin_panel ? '' : 'none';
            if (managerBtn) managerBtn.style.display = data.show_manager_panel ? '' : 'none';
        })
        .catch(function() {
            if (loading) loading.textContent = 'Ошибка загрузки профиля';
            if (block) block.style.display = 'block';
            document.getElementById('profile-name').textContent = 'Профиль';
        });
})();
(function(){
    try {
        const list = document.getElementById('notifications-list');
        // Тоггл модалки и колокола
        const panel = document.getElementById('notifications-panel');
        const bell = document.getElementById('notifications-bell');
        const closeBtn = document.getElementById('notifications-close');

        if (panel && bell && closeBtn) {
            // По умолчанию модалка открыта, колокол скрыт
            bell.style.display = 'none';
            closeBtn.addEventListener('click', function() {
                panel.style.display = 'none';
                bell.style.display = 'flex';
            });
            bell.addEventListener('click', function() {
                panel.style.display = '';
                bell.style.display = 'none';
            });
        }

        if (!list) return;

        // Сохраняем уведомления в localStorage (постоянное хранение) — индивидуально для пользователя
        var userId = panel ? panel.getAttribute('data-user-id') : '';
        const userKey = 'userNotifications_' + String(userId || '');
        const incoming = Array.from(list.querySelectorAll('.notification-item')).map(el => ({
            id: el.getAttribute('data-id') || '',
            text: el.children[0] ? el.children[0].textContent : '',
            time: new Date().toLocaleString()
        })).filter(n => n.id);
        const stored = JSON.parse(localStorage.getItem(userKey) || '[]');
        const existingIds = new Set(stored.map(n => n.id));
        const merged = stored.slice();
        for (const n of incoming) {
            if (!existingIds.has(n.id)) merged.unshift(n);
        }
        localStorage.setItem(userKey, JSON.stringify(merged.slice(0, 100)));
    } catch (e) {}
})();
</script>
{% endblock %}
