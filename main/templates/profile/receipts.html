{% extends 'base.html' %}
{% load static %}

{% block title %}Мои чеки - MPTCOURSE{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<style>
.receipts-content { max-width: 1000px; margin: 0 auto; padding: 60px 20px; }
.receipts-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
.receipts-list { display: flex; flex-direction: column; gap: 16px; }
.receipt-card { background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; display: flex; justify-content: space-between; align-items: center; }
body:not(.dark-theme) .receipt-card { border: 1px solid #000; background: #fff; }
.receipt-info { display: flex; flex-direction: column; gap: 6px; }
.receipt-actions { display: flex; gap: 8px; flex-wrap: wrap; }
.receipt-actions a { margin: 0; }
</style>
{% endblock %}

{% block content %}
<div class="receipts-content">
  <div class="receipts-header">
    <h1>Мои чеки</h1>
    <a href="{% url 'profile' %}">← В профиль</a>
  </div>

  <div id="receipts-loading">Загрузка чеков...</div>
  <div class="receipts-list" id="receipts-list" style="display: none;"></div>
  <p id="receipts-empty" style="display: none;">Чеки еще не сформированы.</p>
</div>
<script>
(function() {
  fetch('/api/receipts/', { method: 'GET', credentials: 'same-origin' })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var loading = document.getElementById('receipts-loading');
      var listEl = document.getElementById('receipts-list');
      var empty = document.getElementById('receipts-empty');
      if (!loading || !listEl) return;
      loading.style.display = 'none';
      var receipts = (data && data.receipts) ? data.receipts : [];
      if (receipts.length === 0) { empty.style.display = 'block'; return; }
      listEl.style.display = 'flex';
      var orderDetailUrl = "{% url 'order_detail' 0 %}".replace('/0/', '/');
      receipts.forEach(function(r) {
        var orderId = r.order || r.order_id || '';
        var created = r.created_at ? new Date(r.created_at).toLocaleString('ru-RU') : '';
        var total = r.total_amount != null ? r.total_amount : '';
        var vatRate = r.vat_rate != null ? r.vat_rate : '20';
        var number = r.number || r.id || '';
        var card = '<div class="receipt-card"><div class="receipt-info">' +
          '<div><strong>Чек №:</strong> ' + number + ' • <strong>Заказ:</strong> #' + orderId + '</div>' +
          '<div><strong>Дата:</strong> ' + created + ' • <strong>Статус:</strong> ' + (r.status || '') + '</div>' +
          '<div><strong>Сумма:</strong> ' + total + ' ₽ • <strong>НДС ' + vatRate + '%</strong></div></div>' +
          '<div class="receipt-actions">' +
          '<a class="btn btn-secondary" href="/profile/receipts/' + r.id + '/pdf/" target="_blank">Открыть чек</a>' +
          '<a class="btn btn-secondary" href="/profile/receipts/' + r.id + '/pdf/?download=1" download>Скачать PDF</a>' +
          '<a class="btn" href="' + orderDetailUrl + orderId + '/">К заказу</a></div></div>';
        listEl.insertAdjacentHTML('beforeend', card);
      });
    })
    .catch(function() {
      var loading = document.getElementById('receipts-loading');
      if (loading) loading.textContent = 'Ошибка загрузки';
    });
})();
</script>
{% endblock %}


