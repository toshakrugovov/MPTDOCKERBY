{% extends 'base.html' %}
{% load static %}

{% block title %}MPTCOURSE - Онлайн-курсы{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock %}

{% block content %}

<!-- Promo Ticker -->
{% if promotions %}
<section class="promo-ticker">
    <div class="ticker-content">
        {% for promo in promotions %}
        <span class="promo-item">{{ promo.promo_code }} – Скидка {{ promo.discount }}%</span>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- Hero: Онлайн-курсы (современный блок в стилистике сайта) -->
<section class="hero-courses">
    <div class="container">
        <div class="hero-courses-inner">
            <div class="hero-courses-label">Платформа MPTCOURSE</div>
            <h1 class="hero-courses-title">Онлайн‑курсы для студентов</h1>
            <p class="hero-courses-lead">
                Короткие модули, понятные объяснения и задания, которые можно проходить в удобном темпе.
            </p>
            <div class="hero-courses-actions">
                <a href="{% url 'catalog' %}" class="btn btn-primary hero-courses-cta">Смотреть каталог</a>
            </div>
        </div>
    </div>
</section>

<!-- Promo Ticker between blocks -->
<section class="promo-ticker">
    <div class="ticker-content">
        {% if promotions %}
            {% for promo in promotions %}
                <span class="promo-item">{{ promo.promo_code }} – Скидка {{ promo.discount }}%</span>
            {% endfor %}
        {% else %}
            <span class="promo-item">Добро пожаловать в MPTCOURSE</span>
            <span class="promo-item">Оплата картой, СБП или с баланса</span>
        {% endif %}
    </div>
</section>

<!-- Курсы: загрузка через API -->
<section class="products-section" id="home-courses-section">
    <div class="container">
        <h2 class="section-title">Рекомендуемые курсы</h2>
        <div id="home-courses-loading" class="catalog-loading">Загрузка...</div>
        <div id="home-products-grid" class="products-grid" style="display: none;"></div>
        <p id="home-courses-empty" class="catalog-empty" style="display: none;">Курсы не найдены.</p>
        <p style="text-align: center; margin-top: 1rem;">
            <a href="{% url 'catalog' %}" class="btn btn-primary">Смотреть весь каталог</a>
        </p>
    </div>
</section>

<script>
(function() {
    fetch('/api/catalog/?per_page=12', { method: 'GET', credentials: 'same-origin' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var loading = document.getElementById('home-courses-loading');
            var grid = document.getElementById('home-products-grid');
            var empty = document.getElementById('home-courses-empty');
            if (!loading || !grid) return;
            loading.style.display = 'none';
            var list = (data && data.products) ? data.products : [];
            if (list.length === 0) {
                if (empty) empty.style.display = 'block';
                return;
            }
            if (empty) empty.style.display = 'none';
            grid.style.display = 'grid';
            grid.innerHTML = '';
            var catalogUrl = "{% url 'catalog' %}";
            list.forEach(function(p) {
                var img = p.main_image_url || p.cover_image_path || '';
                var priceHtml = (p.discount && parseFloat(p.discount) > 0)
                    ? '<span class="product-old-price">' + (p.price || '') + ' ₽</span> ' + (p.final_price || p.price) + ' ₽ <span class="product-discount">-' + p.discount + '%</span>'
                    : (p.price || '') + ' ₽';
                var title = (p.title || '').replace(/</g, '&lt;').replace(/"/g, '&quot;');
                var card = document.createElement('a');
                card.href = catalogUrl;
                card.className = 'product-card';
                card.style.textDecoration = 'none';
                card.style.color = 'inherit';
                card.innerHTML = '<div class="product-image">' + (img ? '<img src="' + img + '" alt="' + title + '">' : 'Курс') + '</div>' +
                    '<div class="product-info"><h3 class="product-name">' + title + '</h3><div class="product-price">' + priceHtml + '</div></div>';
                grid.appendChild(card);
            });
        })
        .catch(function() {
            var loading = document.getElementById('home-courses-loading');
            if (loading) loading.textContent = 'Ошибка загрузки';
        });
})();
</script>

{% endblock %}
