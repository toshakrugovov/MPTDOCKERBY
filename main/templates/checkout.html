{% extends 'base.html' %}
{% load static %}

{% block title %}–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ - MPTCOURSE{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<link rel="stylesheet" href="{% static 'css/checkout.css' %}">
{% endblock %}

{% block content %}
<div class="checkout-content">
    <div class="checkout-header">
        <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>
        <a href="{% url 'cart' %}">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–æ—Ä–∑–∏–Ω—É</a>
    </div>

    <form method="post" class="checkout-container" id="checkout-form" onsubmit="return false;">
        {% csrf_token %}
        <input type="hidden" name="saved_payment_id" id="saved_payment_id_input" value="">
        <input type="hidden" name="address_id" value="">

        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –§–æ—Ä–º–∞ -->
        <div class="checkout-form">
            <!-- –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã -->
            <div class="form-section">
                <h2>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</h2>
                <div class="radio-item" style="margin-bottom: 12px;">
                    <input type="radio" name="payment_method" id="payment_sbp" value="sbp" checked>
                    <label for="payment_sbp">
                        <div><strong>–°–ë–ü</strong></div>
                        <div class="radio-item-info">–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –°–∏—Å—Ç–µ–º—É –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π</div>
                    </label>
                </div>
                <div style="text-align: center; margin: 16px 0; color: var(--text-color-secondary);">–∏–ª–∏</div>
                <div id="checkout-payment-dynamic">
                    <div id="checkout-payment-loading" style="padding: 12px; color: var(--text-color-secondary);">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–æ—Å–æ–±–æ–≤ –æ–ø–ª–∞—Ç—ã...</div>
                </div>
                <div class="radio-item">
                    <input type="radio" name="payment_method" id="new_payment" value="card">
                    <label for="new_payment"><strong>–ù–æ–≤–∞—è –∫–∞—Ä—Ç–∞</strong></label>
                </div>

                <div id="new-card-form" style="margin-top: 16px; display: none;">
                    <div class="form-group">
                        <label for="card_number">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã *</label>
                        <input type="text" id="card_number" name="card_number" placeholder="1234 5678 9012 3456" maxlength="19" pattern="[0-9\s]+" {% if not saved_payments %}required{% endif %}>
                    </div>
                    <div class="form-group">
                        <label for="card_holder_name">–ò–º—è –¥–µ—Ä–∂–∞—Ç–µ–ª—è –∫–∞—Ä—Ç—ã *</label>
                        <input type="text" id="card_holder_name" name="card_holder_name" placeholder="IVAN IVANOV" {% if not saved_payments %}required{% endif %}>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expiry_month">–ú–µ—Å—è—Ü *</label>
                            <input type="text" id="expiry_month" name="expiry_month" placeholder="MM" maxlength="2" pattern="[0-9]{2}" {% if not saved_payments %}required{% endif %}>
                        </div>
                        <div class="form-group">
                            <label for="expiry_year">–ì–æ–¥ *</label>
                            <input type="text" id="expiry_year" name="expiry_year" placeholder="YYYY" maxlength="4" pattern="[0-9]{4}" {% if not saved_payments %}required{% endif %}>
                        </div>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="save_card" name="save_card">
                        <label for="save_card">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –ø–æ–∫—É–ø–æ–∫</label>
                    </div>
                </div>
            </div>

            <!-- –ü—Ä–æ–º–æ–∫–æ–¥ -->
            <div class="form-section">
                <h2>–ü—Ä–æ–º–æ–∫–æ–¥</h2>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label for="promo_code_input">–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="promo_code_input" name="promo_code_input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <button type="button" id="apply_promo_btn" style="padding: 10px 20px; background: var(--text-color); color: var(--bg-color); border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    </div>
                </div>
                <div id="promo_message" style="margin-top:8px; font-size:12px; color: var(--text-color); display:none;"></div>
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                    <h3 style="font-size: 14px; margin-bottom: 12px; color: var(--text-color-secondary);">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã:</h3>
                    <div id="promotions-container">
                        <div id="promotions-loading" style="text-align: center; padding: 20px; color: var(--text-color-secondary);">
                            –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤...
                        </div>
                        <div id="promotions-list" style="display: none;"></div>
                        <div id="promotions-empty" style="display: none; text-align: center; padding: 20px; color: var(--text-color-secondary);">
                            –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="checkout-summary">
            <h2>–ò—Ç–æ–≥–æ</h2>

            <div id="checkout-summary-loading" style="padding: 16px; color: var(--text-color-secondary);">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã...</div>
            <div class="cart-items-summary" id="cart-items-summary" style="display: none;"></div>

            <div class="summary-item">
                <span class="summary-item-label">–¢–æ–≤–∞—Ä—ã:</span>
                <span class="summary-item-value" id="subtotal-value">0 ‚ÇΩ</span>
            </div>
            <div class="summary-item" id="discount-item" style="display: none;">
                <span class="summary-item-label discount">–°–∫–∏–¥–∫–∞:</span>
                <span class="summary-item-value discount" id="discount-value">0 ‚ÇΩ</span>
            </div>
            <div class="summary-item" style="color: var(--text-color-secondary); font-size: 14px;">
                <span class="summary-item-label">–î–æ—Å—Ç–∞–≤–∫–∞:</span>
                <span class="summary-item-value" id="delivery-value">–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è</span>
            </div>
            <div class="summary-item">
                <span class="summary-item-label">–ù–î–° <span id="vat-rate-label">20</span>%:</span>
                <span class="summary-item-value" id="vat-value">0 ‚ÇΩ</span>
            </div>
            <div class="summary-item total">
                <span class="summary-item-label">–ò—Ç–æ–≥–æ:</span>
                <span class="summary-item-value" id="total-value">0 ‚ÇΩ</span>
            </div>

            <button type="submit" class="submit-button">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>
    </form>
</div>

<script>
(function loadCheckoutContext() {
    var paymentLoading = document.getElementById('checkout-payment-loading');
    var paymentDynamic = document.getElementById('checkout-payment-dynamic');
    var summaryLoading = document.getElementById('checkout-summary-loading');
    var cartItemsSummary = document.getElementById('cart-items-summary');
    var totalPrice = 0;
    fetch('/api/checkout-context/', { method: 'GET', credentials: 'same-origin' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (!data || !data.success) return;
            totalPrice = parseFloat(data.subtotal || 0);
            var userBalance = parseFloat(data.user_balance || 0);
            var payments = data.payment_methods || [];
            var cart = data.cart || {};
            var items = (cart.items || []);
            if (paymentLoading) paymentLoading.style.display = 'none';
            var html = '';
            if (userBalance > 0) {
                var balanceDisabled = userBalance < totalPrice ? ' disabled' : '';
                html += '<div class="radio-item" style="margin-bottom: 12px;"><input type="radio" name="payment_method" id="payment_balance" value="balance"' + balanceDisabled + '><label for="payment_balance"><div><strong>–õ–∏—á–Ω—ã–π —Å—á—ë—Ç</strong></div><div class="radio-item-info">–ë–∞–ª–∞–Ω—Å: <strong>' + userBalance + ' ‚ÇΩ</strong>' + (userBalance < totalPrice ? '<span style="color: var(--text-color-secondary);"> (–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤)</span>' : '') + '</div></label></div><div style="text-align: center; margin: 16px 0; color: var(--text-color-secondary);">–∏–ª–∏</div>';
            }
            payments.forEach(function(p) {
                var bal = parseFloat(p.balance || 0);
                var mask = p.mask_card_number || ('**** ' + (p.card_number || '****'));
                var cardType = (p.card_type || 'CARD').toUpperCase();
                html += '<div class="radio-item" data-card-balance="' + bal + '" data-card-id="' + p.id + '"><input type="radio" name="payment_method" id="saved_payment_' + p.id + '" value="card" data-saved-id="' + p.id + '"><label for="saved_payment_' + p.id + '"><div><strong>' + cardType + ' ' + mask + '</strong></div><div class="radio-item-info">–ë–∞–ª–∞–Ω—Å: <strong>' + bal + ' ‚ÇΩ</strong>' + (p.is_default ? ' (–û—Å–Ω–æ–≤–Ω–æ–π)' : '') + '<span class="insufficient-funds" style="color: var(--text-color-secondary); display: none;"> (–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤)</span></div></label></div>';
            });
            if (html) html += '<div style="text-align: center; margin: 16px 0; color: var(--text-color-secondary);">–∏–ª–∏</div>';
            if (paymentDynamic) paymentDynamic.insertAdjacentHTML('beforeend', html);
            var newCardForm = document.getElementById('new-card-form');
            if (newCardForm) newCardForm.style.display = payments.length ? 'none' : 'block';
            if (summaryLoading) summaryLoading.style.display = 'none';
            if (cartItemsSummary) {
                cartItemsSummary.style.display = 'block';
                cartItemsSummary.innerHTML = '';
                items.forEach(function(item) {
                    var course = item.course || {};
                    var title = course.title || item.course_title || '–ö—É—Ä—Å';
                    var img = course.main_image_url || course.cover_image_path || item.course_cover_image || '';
                    var qty = item.quantity || 1;
                    var unitPrice = parseFloat(item.unit_price || 0);
                    var subtotal = (unitPrice * qty).toFixed(0);
                    var row = '<div class="cart-item-summary">' + (img ? '<img src="' + img + '" alt="" class="cart-item-image">' : '<div class="cart-item-image" style="display: flex; align-items: center; justify-content: center; color: var(--text-color-secondary); font-size: 10px;">–ö—É—Ä—Å</div>') + '<div class="cart-item-info"><div class="cart-item-name">' + title.replace(/</g, '&lt;') + '</div><div class="cart-item-details">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ' + qty + '</div></div><div class="cart-item-price">' + subtotal + ' ‚ÇΩ</div></div>';
                    cartItemsSummary.insertAdjacentHTML('beforeend', row);
                });
            }
            var subtotalEl = document.getElementById('subtotal-value');
            var vatEl = document.getElementById('vat-value');
            var totalEl = document.getElementById('total-value');
            var vatRateLabel = document.getElementById('vat-rate-label');
            if (subtotalEl) subtotalEl.textContent = (data.subtotal || '0') + ' ‚ÇΩ';
            if (vatEl) vatEl.textContent = (data.vat_amount || '0') + ' ‚ÇΩ';
            if (totalEl) totalEl.textContent = (data.total_with_vat || '0') + ' ‚ÇΩ';
            if (vatRateLabel) vatRateLabel.textContent = data.vat_rate || '20';
            if (typeof updateCardBalances === 'function') updateCardBalances();
            if (typeof updateSubmitButton === 'function') updateSubmitButton();
        })
        .catch(function() {
            if (paymentLoading) paymentLoading.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            if (summaryLoading) summaryLoading.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã';
        });
})();
// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
window.addEventListener('error', function(e) {
    console.error('‚ùå –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ JavaScript:', {
        message: e.message,
        filename: e.filename,
        lineno: e.lineno,
        colno: e.colno,
        error: e.error,
        stack: e.error ? e.error.stack : null
    });
    console.error('–ü—Ä–∏—á–∏–Ω–∞ –æ—à–∏–±–∫–∏:', e.error ? e.error.toString() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
    // –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
    return true;
}, true);

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–∏—Å–æ–≤
window.addEventListener('unhandledrejection', function(e) {
    console.error('‚ùå –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ Promise:', e.reason);
    console.error('–ü—Ä–∏—á–∏–Ω–∞:', e.reason ? e.reason.toString() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
    if (e.reason && e.reason.stack) {
        console.error('Stack trace:', e.reason.stack);
    }
});

function parseAmount(text) { 
    const cleaned = text.replace(/[^\d.,]/g, ''); 
    return parseFloat(cleaned.replace(',', '.')) || 0; 
}

function formatAmount(amount) { 
    return amount.toFixed(2) + ' ‚ÇΩ'; 
}

function getTotalAmount() {
    try {
        const subtotalEl = document.getElementById('subtotal-value');
        if (!subtotalEl) return 0;
        const subtotalText = subtotalEl.textContent || '0';
    const subtotal = parseAmount(subtotalText);
    const discountItem = document.getElementById('discount-item');
    let discount = 0;
    if (discountItem && discountItem.style.display !== 'none') {
            const discountValueEl = document.getElementById('discount-value');
            if (discountValueEl) {
                const discountText = discountValueEl.textContent || '0';
        discount = parseAmount(discountText);
    }
        }
        const deliveryEl = document.getElementById('delivery-value');
        if (!deliveryEl) return subtotal;
        const deliveryText = deliveryEl.textContent || '0';
    const delivery = parseAmount(deliveryText);
    const amountAfterDiscount = subtotal - discount + delivery; // –¢–æ–≤–∞—Ä—ã - —Å–∫–∏–¥–∫–∞ + –¥–æ—Å—Ç–∞–≤–∫–∞
    const vatRate = 20;
    const vatRounded = Math.round((amountAfterDiscount * vatRate / 100) * 100) / 100;
    const totalRounded = Math.round((amountAfterDiscount + vatRounded) * 100) / 100;
    return totalRounded;
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –≤ getTotalAmount:', e);
        return 0;
    }
}

function calculateTotal() {
    try {
    const totalRounded = getTotalAmount();
    const vatElement = document.getElementById('vat-value');
    const totalElement = document.getElementById('total-value');
    if (vatElement) {
            const subtotalEl = document.getElementById('subtotal-value');
            if (!subtotalEl) return;
            const subtotalText = subtotalEl.textContent || '0';
        const subtotal = parseAmount(subtotalText);
        const discountItem = document.getElementById('discount-item');
        let discount = 0;
        if (discountItem && discountItem.style.display !== 'none') {
                const discountValueEl = document.getElementById('discount-value');
                if (discountValueEl) {
                    const discountText = discountValueEl.textContent || '0';
            discount = parseAmount(discountText);
        }
            }
            const deliveryEl = document.getElementById('delivery-value');
            if (!deliveryEl) return;
            const deliveryText = deliveryEl.textContent || '0';
        const delivery = parseAmount(deliveryText);
        const amountAfterDiscount = subtotal - discount + delivery; // –¢–æ–≤–∞—Ä—ã - —Å–∫–∏–¥–∫–∞ + –¥–æ—Å—Ç–∞–≤–∫–∞
        const vatRate = 20;
        const vatRounded = Math.round((amountAfterDiscount * vatRate / 100) * 100) / 100;
        vatElement.textContent = formatAmount(vatRounded);
    }
    if (totalElement) totalElement.textContent = formatAmount(totalRounded);
    updateCardBalances();
    updateSubmitButton();
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –≤ calculateTotal:', e);
    }
}

function updateCardBalances() {
    try {
    const totalAmount = getTotalAmount();
        const cardItems = document.querySelectorAll('.radio-item[data-card-balance]');
        if (!cardItems || cardItems.length === 0) return;
        
        cardItems.forEach(cardItem => {
            if (!cardItem) return;
            
            try {
                const cardBalanceAttr = cardItem.getAttribute('data-card-balance');
                const cardBalance = parseFloat(cardBalanceAttr) || 0;
        const insufficientFundsSpan = cardItem.querySelector('.insufficient-funds');
        const radioInput = cardItem.querySelector('input[type="radio"]');
        
        if (cardBalance < totalAmount) {
            if (insufficientFundsSpan) insufficientFundsSpan.style.display = 'inline';
            if (radioInput) {
                radioInput.disabled = true;
                if (radioInput.checked) {
                    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å—Ç–∞–ª–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –°–ë–ü
                    const sbpRadio = document.getElementById('payment_sbp');
                            if (sbpRadio) {
                                sbpRadio.checked = true;
                                // –ù–µ –≤—ã–∑—ã–≤–∞–µ–º dispatchEvent, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫
                                // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –≤—ã–∑—ã–≤–∞–µ–º updateSubmitButton –Ω–∞–ø—Ä—è–º—É—é
                                try {
                                    updateSubmitButton();
                                } catch (e) {
                                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ updateSubmitButton:', e);
                                }
                            }
                }
            }
        } else {
            if (insufficientFundsSpan) insufficientFundsSpan.style.display = 'none';
            if (radioInput) radioInput.disabled = false;
                }
            } catch (e) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –∫–∞—Ä—Ç—ã:', e);
        }
    });
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –≤ updateCardBalances:', e);
    }
}

function updateSubmitButton() {
    const submitButton = document.querySelector('.submit-button');
    if (!submitButton) return;
    
    const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
    if (!selectedPayment) {
        submitButton.disabled = true;
        return;
    }
    
    const paymentMethod = selectedPayment.value;
    const totalAmount = getTotalAmount();
    let canSubmit = true;
    
    if (paymentMethod === 'sbp') {
        // –°–ë–ü - –≤—Å–µ–≥–¥–∞ –º–æ–∂–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç—å
        canSubmit = true;
    } else if (paymentMethod === 'balance') {
        const balanceRadio = document.querySelector('#payment_balance');
        const balanceItem = balanceRadio ? balanceRadio.closest('.radio-item') : null;
        const balanceText = balanceItem ? balanceItem.querySelector('.radio-item-info strong')?.textContent : null;
        const balance = balanceText ? parseAmount(balanceText) : 0;
        if (balance < totalAmount) {
            canSubmit = false;
        }
    } else if (paymentMethod === 'card') {
        const savedPaymentId = selectedPayment.getAttribute('data-saved-id');
        if (savedPaymentId) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã
            const cardItem = document.querySelector(`.radio-item[data-card-id="${savedPaymentId}"]`);
            if (cardItem) {
                const cardBalance = parseFloat(cardItem.getAttribute('data-card-balance')) || 0;
                if (cardBalance < totalAmount) {
                    canSubmit = false;
                }
            }
        } else if (selectedPayment.id === 'new_payment') {
            // –î–ª—è –Ω–æ–≤–æ–π –∫–∞—Ä—Ç—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∏–¥–Ω–∞ –ª–∏ —Ñ–æ—Ä–º–∞ –∫–∞—Ä—Ç—ã
            const newCardForm = document.getElementById('new-card-form');
            if (newCardForm && newCardForm.style.display !== 'none') {
                // –§–æ—Ä–º–∞ –≤–∏–¥–Ω–∞ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π
            const cardNumber = document.getElementById('card_number')?.value.trim();
            const cardHolderName = document.getElementById('card_holder_name')?.value.trim();
            const expiryMonth = document.getElementById('expiry_month')?.value.trim();
            const expiryYear = document.getElementById('expiry_year')?.value.trim();
            
                if (!cardNumber || !cardHolderName || !expiryMonth || !expiryYear) {
                    canSubmit = false;
                }
            }
            // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞ —Å–∫—Ä—ã—Ç–∞ - –º–æ–∂–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç—å (–°–ë–ü)
        }
    }
    
    submitButton.disabled = !canSubmit;
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Å–ø–æ—Å–æ–±–∞–º–∏ –æ–ø–ª–∞—Ç—ã
function setupPaymentMethodHandlers() {
    try {
        const paymentRadios = document.querySelectorAll('input[name="payment_method"]');
        if (!paymentRadios || paymentRadios.length === 0) return;
        
        paymentRadios.forEach(radio => {
            if (!radio) return;
            try {
                radio.addEventListener('change', function(e) {
                    try {
                        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ª—é–±—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                        if (e) {
                            e.preventDefault();
                            e.stopPropagation();
                        }
                        
        const newCardForm = document.getElementById('new-card-form');
                        if (!this) return;
        const paymentMethod = this.value;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ saved_payment_id
                        const savedPaymentIdInput = document.getElementById('saved_payment_id_input');
                        const savedPaymentId = this.getAttribute('data-saved-id');
                        if (savedPaymentIdInput) {
                            savedPaymentIdInput.value = savedPaymentId || '';
                        }
                        
        if (paymentMethod === 'sbp' || paymentMethod === 'balance') {
                            if (newCardForm) {
            newCardForm.style.display = 'none';
                            }
            ['card_number','card_holder_name','expiry_month','expiry_year'].forEach(id => {
                const el = document.getElementById(id);
                                if (el) {
                                    el.required = false;
                                    el.removeAttribute('required');
                                }
            });
        } else if (paymentMethod === 'card') {
            const savedPaymentId = this.getAttribute('data-saved-id');
            if (this.id === 'new_payment' || !savedPaymentId) {
                                if (newCardForm) {
                newCardForm.style.display = 'block';
                                }
                ['card_number','card_holder_name','expiry_month','expiry_year'].forEach(id => {
                    const el = document.getElementById(id);
                                    if (el) {
                                        el.required = true;
                                        el.setAttribute('required', 'required');
                                    }
                });
            } else {
                                if (newCardForm) {
                newCardForm.style.display = 'none';
                                }
                ['card_number','card_holder_name','expiry_month','expiry_year'].forEach(id => {
                    const el = document.getElementById(id);
                                    if (el) {
                                        el.required = false;
                                        el.removeAttribute('required');
                                    }
                });
            }
        }
        updateSubmitButton();
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ change –¥–ª—è payment_method:', e);
                    }
    });
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–ª—è payment_method:', e);
            }
});
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –≤ setupPaymentMethodHandlers:', e);
    }
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∞–¥—Ä–µ—Å–∞
function setupAddressHandlers() {
    try {
        const addressRadios = document.querySelectorAll('input[name="address_id"]');
        if (!addressRadios || addressRadios.length === 0) return;
        
        addressRadios.forEach(radio => {
            if (!radio) return;
            try {
    radio.addEventListener('change', function() {
                    try {
        updateSubmitButton();
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ change –¥–ª—è address_id:', e);
                    }
    });
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–ª—è address_id:', e);
            }
});
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –≤ setupAddressHandlers:', e);
    }
}

// –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —á–µ–∫–±–æ–∫—Å–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
const saveCardCheckbox = document.getElementById('save_card');
if (saveCardCheckbox) {
    saveCardCheckbox.addEventListener('change', function() {
        updateSubmitButton();
    });
}

function getCookie(name) {
    let cookieValue = null;
    if(document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for(let cookie of cookies){
            cookie = cookie.trim();
            if(cookie.startsWith(name + '=')){
                cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                break;
            }
        }
    }
    if(!cookieValue){
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if(csrfInput) cookieValue = csrfInput.value;
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ç–æ—á–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
    setTimeout(function() {
        try {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
            setupPaymentMethodHandlers();
            setupAddressHandlers();
    
    const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
            if (selectedPayment) {
                try {
                    // –ù–µ –≤—ã–∑—ã–≤–∞–µ–º dispatchEvent, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫
                    // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞–ø—Ä—è–º—É—é
                    const newCardForm = document.getElementById('new-card-form');
                    if (newCardForm) {
                        const paymentMethod = selectedPayment.value;
                        if (paymentMethod === 'sbp' || paymentMethod === 'balance') {
                            newCardForm.style.display = 'none';
                        }
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ selectedPayment:', e);
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º —Ñ—É–Ω–∫—Ü–∏–π
            const subtotalEl = document.getElementById('subtotal-value');
            const totalEl = document.getElementById('total-value');
            if (subtotalEl && totalEl) {
    calculateTotal();
    updateCardBalances();
    updateSubmitButton();
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–º–æ–∫–æ–¥—ã
            loadAvailablePromotions();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ñ–æ—Ä–º—ã
            try {
                const checkoutForm = document.getElementById('checkout-form');
                if (!checkoutForm) {
                    console.error('–§–æ—Ä–º–∞ checkout-form –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                } else if (!checkoutForm.hasAttribute('data-handler-initialized')) {
                    checkoutForm.setAttribute('data-handler-initialized', 'true');
                    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ñ–æ—Ä–º—ã checkout-form');
                    checkoutForm.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ submit –≤—ã–∑–≤–∞–Ω');
                        
                        const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
                        const submitButton = document.querySelector('.submit-button');
                        
                        if (!submitButton) {
                            alert('–û—à–∏–±–∫–∞: –∫–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                            console.error('–ö–Ω–æ–ø–∫–∞ submit-button –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                            return false;
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                        const paymentMethod = selectedPayment?.value || 'sbp';
                        const totalAmount = getTotalAmount();
                        let hasEnoughFunds = true;
                        
                        if (paymentMethod === 'balance') {
                            const balanceRadio = document.querySelector('#payment_balance');
                            const balanceItem = balanceRadio ? balanceRadio.closest('.radio-item') : null;
                            const balanceText = balanceItem ? balanceItem.querySelector('.radio-item-info strong')?.textContent : null;
                            const balance = balanceText ? parseAmount(balanceText) : 0;
                            if (balance < totalAmount) {
                                hasEnoughFunds = false;
                            }
                        } else if (paymentMethod === 'card') {
                            const savedPaymentId = selectedPayment?.getAttribute('data-saved-id');
                            if (savedPaymentId) {
                                const cardItem = document.querySelector(`.radio-item[data-card-id="${savedPaymentId}"]`);
                                if (cardItem) {
                                    const cardBalance = parseFloat(cardItem.getAttribute('data-card-balance')) || 0;
                                    if (cardBalance < totalAmount) {
                                        hasEnoughFunds = false;
                                    }
                                }
                            }
                        }
                        
                        if (submitButton && submitButton.disabled && !hasEnoughFunds) {
                            alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º –æ–ø–ª–∞—Ç—ã.');
                            return false;
                        }
                        
                        const savedPaymentId = selectedPayment?.getAttribute('data-saved-id') || '';
                        
                        // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–º–æ–∫–æ–¥ –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω)
                        const promoCodeInput = document.getElementById('promo_code_input')?.value.trim().toUpperCase() || '';
                        const data = {
                            payment_method: paymentMethod
                        };
                        // –ï—Å–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥ –≤–≤–µ–¥–µ–Ω –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω, –ø–µ—Ä–µ–¥–∞–µ–º –µ–≥–æ
                        if (promoCodeInput) {
                            data.promo_code = promoCodeInput;
                        }
                        
                        if (paymentMethod === 'card') {
                            if (savedPaymentId) {
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                                const cardItem = document.querySelector(`.radio-item[data-card-id="${savedPaymentId}"]`);
                                if (cardItem) {
                                    const cardBalance = parseFloat(cardItem.getAttribute('data-card-balance')) || 0;
                                    const totalAmount = getTotalAmount();
                                    if (cardBalance < totalAmount) {
                                        alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –∫–∞—Ä—Ç–µ. –ë–∞–ª–∞–Ω—Å: ${cardBalance.toFixed(2)} ‚ÇΩ, —Ç—Ä–µ–±—É–µ—Ç—Å—è: ${totalAmount.toFixed(2)} ‚ÇΩ`);
                                        submitButton.disabled = false;
                                        submitButton.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
                                        return false;
                                    }
                                }
                                data.saved_payment_id = savedPaymentId;
                            } else {
                                // –ù–æ–≤–∞—è –∫–∞—Ä—Ç–∞ - –ø–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
                                const cardNumber = document.getElementById('card_number')?.value.trim() || '';
                                const cardHolderName = document.getElementById('card_holder_name')?.value.trim() || '';
                                const expiryMonth = document.getElementById('expiry_month')?.value.trim() || '';
                                const expiryYear = document.getElementById('expiry_year')?.value.trim() || '';
                                const saveCard = document.getElementById('save_card')?.checked || false;
                                
                                const newCardForm = document.getElementById('new-card-form');
                                // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞ –≤–∏–¥–Ω–∞, —Ç—Ä–µ–±—É–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
                                if (newCardForm && newCardForm.style.display !== 'none') {
                                    if (!cardNumber || !cardHolderName || !expiryMonth || !expiryYear) {
                                        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–∞—Ä—Ç—ã');
                                        submitButton.disabled = false;
                                        submitButton.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
                                        return false;
                                    }
                                }
                                
                                // –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
                                if (cardNumber && cardHolderName && expiryMonth && expiryYear) {
                                    data.card_number = cardNumber;
                                    data.card_holder_name = cardHolderName;
                                    data.expiry_month = expiryMonth;
                                    data.expiry_year = expiryYear;
                                    data.save_card = saveCard;
                                }
                            }
            } else if (paymentMethod === 'balance') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const balanceRadio = document.querySelector('#payment_balance');
                const balanceItem = balanceRadio ? balanceRadio.closest('.radio-item') : null;
                const balanceText = balanceItem ? balanceItem.querySelector('.radio-item-info strong')?.textContent : null;
                const balance = balanceText ? parseAmount(balanceText) : 0;
                const totalAmount = getTotalAmount();
                if (balance < totalAmount) {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ. –ë–∞–ª–∞–Ω—Å: ${balance.toFixed(2)} ‚ÇΩ, —Ç—Ä–µ–±—É–µ—Ç—Å—è: ${totalAmount.toFixed(2)} ‚ÇΩ`);
                    submitButton.disabled = false;
                    submitButton.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
                    return false;
                }
            }
                    
                        submitButton.disabled = true;
                        submitButton.textContent = '–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ...';
                        
                        const csrfToken = getCookie('csrftoken');
                        
                        try {
                            const response = await fetch('/api/orders/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken || ''
                                },
                                credentials: 'same-origin',
                                body: JSON.stringify(data)
                            });
                        
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º JSON
                            if (!response.ok) {
                                const errorText = await response.text();
                                let errorData;
                                try {
                                    errorData = JSON.parse(errorText);
                                } catch {
                                    // –ï—Å–ª–∏ —ç—Ç–æ HTML (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—à–∏–±–∫–∏ 500), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—ë
                                    if (response.status === 500 && (errorText.includes('<!DOCTYPE html>') || errorText.includes('<html'))) {
                                        // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Å–æ–ª—å
                                        console.error('‚ùå –û—à–∏–±–∫–∞ 500 –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
                                        console.error('–°—Ç–∞—Ç—É—Å:', response.status);
                                        console.error('URL:', response.url);
                                        console.error('–î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞:', data);
                                        console.error('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (HTML):', errorText.substring(0, 500) + '...');
                                        
                                        // –ó–∞–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—à–∏–±–∫–∏
                                        try {
                                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π URL –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é"
                                            document.documentElement.innerHTML = errorText;
                                            
                                            // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã –ø–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã HTML
                                            setTimeout(function() {
                                                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                                                var adminButton = document.getElementById('adminButton');
                                                if (adminButton) {
                                                    adminButton.addEventListener('click', function(e) {
                                                        e.preventDefault();
                                                        e.stopPropagation();
                                                        console.log('–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
                                                        window.location.href = '/admin-secret-check/';
                                                    });
                                                }
                                                
                                                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                                                document.addEventListener('click', function(e) {
                                                    if (e.target && e.target.id === 'adminButton') {
                                                        e.preventDefault();
                                                        e.stopPropagation();
                                                        window.location.href = '/admin-secret-check/';
                                                    }
                                                }, true);
                                            }, 100);
                                        } catch (e) {
                                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–º–µ–Ω–µ HTML:', e);
                                            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                                        }
                                        return;
                                    }
                                    errorData = { error: errorText || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞' };
                                }
                                
                                // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –≤ –∫–æ–Ω—Å–æ–ª—å
                                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
                                console.error('–°—Ç–∞—Ç—É—Å:', response.status);
                                console.error('URL:', response.url);
                                console.error('–î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞:', data);
                                console.error('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', errorData);
                                
                                const errorMsg = errorData.error || errorData.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞';
                                
                                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–æ–º —Å—Ä–µ–¥—Å—Ç–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                                if (errorMsg.includes('–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ') || errorMsg.includes('–±–∞–ª–∞–Ω—Å') || errorMsg.includes('—Å—Ä–µ–¥—Å—Ç–≤')) {
                                    alert(`–û—à–∏–±–∫–∞: ${errorMsg}`);
                                } else if (errorMsg.includes('–Ω–µ –Ω–∞–π–¥–µ–Ω') || errorMsg.includes('—Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö')) {
                                    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å—é –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
                                    if (confirm(errorMsg + '\n\n–û–±–Ω–æ–≤–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–æ—Ä–∑–∏–Ω—ã?')) {
                                        window.location.href = '/cart/';
                                        return;
                                    }
                                } else {
                                    alert(`–û—à–∏–±–∫–∞ ${response.status}: ${errorMsg}`);
                                }
                                submitButton.disabled = false;
                                submitButton.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
                                return;
                            }
                            
                            const result = await response.json();
                            
                            console.log('üîç –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞:', result);
                            
                            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å ID –∑–∞–∫–∞–∑–∞ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
                            let orderId = null;
                            
                            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: result.order_id (–ø—Ä—è–º–æ–µ –ø–æ–ª–µ)
                            if (result.order_id) {
                                orderId = result.order_id;
                                console.log('‚úÖ ID –Ω–∞–π–¥–µ–Ω –≤ result.order_id:', orderId);
                            }
                            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: result.order.id (–≤–ª–æ–∂–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç)
                            else if (result.order && result.order.id) {
                                orderId = result.order.id;
                                console.log('‚úÖ ID –Ω–∞–π–¥–µ–Ω –≤ result.order.id:', orderId);
                            }
                            // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: result.id (–µ—Å–ª–∏ order —ç—Ç–æ —Å–∞–º –æ–±—ä–µ–∫—Ç –∑–∞–∫–∞–∑–∞)
                            else if (result.id) {
                                orderId = result.id;
                                console.log('‚úÖ ID –Ω–∞–π–¥–µ–Ω –≤ result.id:', orderId);
                            }
                            
                            console.log('üîç –ò—Ç–æ–≥–æ–≤—ã–π orderId:', orderId);
                            console.log('üîç result.success:', result.success);
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∏ –Ω–∞–ª–∏—á–∏–µ ID
                            if (orderId) {
                                console.log(`‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ! ID: ${orderId}`);
                                window.location.href = `/profile/orders/${orderId}/`;
                            } else if (result.success) {
                                // –ï—Å–ª–∏ success = true, –Ω–æ ID –Ω–µ –Ω–∞–π–¥–µ–Ω
                                console.error('‚ùå –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω (success=true), –Ω–æ ID –Ω–µ –Ω–∞–π–¥–µ–Ω. –†–µ–∑—É–ª—å—Ç–∞—Ç:', result);
                                alert(`–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –∑–∞–∫–∞–∑–∞.\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.`);
                                submitButton.disabled = false;
                                submitButton.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
                            } else {
                                // –ï—Å–ª–∏ success = false –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                                console.error('‚ùå –ó–∞–∫–∞–∑ –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ. –†–µ–∑—É–ª—å—Ç–∞—Ç:', result);
                                const errorMsg = result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                                alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ${errorMsg}`);
                                submitButton.disabled = false;
                                submitButton.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
                            }
                        } catch (error) {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞:', error);
                            console.error('–¢–∏–ø –æ—à–∏–±–∫–∏:', error.name);
                            console.error('–°–æ–æ–±—â–µ–Ω–∏–µ:', error.message);
                            console.error('–î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞:', data);
                            if (error.stack) {
                                console.error('Stack trace:', error.stack);
                            }
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message);
                            if (submitButton) {
                                submitButton.disabled = false;
                                submitButton.textContent = '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑';
                            }
                        }
                    });
                    console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω');
                    
                    // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ —Å–∞–º—É –∫–Ω–æ–ø–∫—É –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
                    const submitButton = document.querySelector('.submit-button');
                    if (submitButton && !submitButton.hasAttribute('data-handler-added')) {
                        submitButton.setAttribute('data-handler-added', 'true');
                        submitButton.addEventListener('click', function(e) {
                            // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∞—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Ä—É—á–Ω—É—é
                            const form = document.getElementById('checkout-form');
                            if (form) {
                                const formEvent = new Event('submit', { bubbles: true, cancelable: true });
                                form.dispatchEvent(formEvent);
                            }
                        });
                    }
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ñ–æ—Ä–º—ã:', e);
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ DOM:', e);
        }
    }, 100);
});

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
    function loadAvailablePromotions() {
    try {
        const loadingEl = document.getElementById('promotions-loading');
        const listEl = document.getElementById('promotions-list');
        const emptyEl = document.getElementById('promotions-empty');
        
        if (!loadingEl || !listEl || !emptyEl) {
            console.log('–≠–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É');
            return;
        }
        
        fetch('/api/available-promotions/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (loadingEl) loadingEl.style.display = 'none';
            
            if (data.success && data.promotions && data.promotions.length > 0) {
                if (emptyEl) emptyEl.style.display = 'none';
                if (listEl) {
                    listEl.style.display = 'block';
                    listEl.innerHTML = '';
                    
                    data.promotions.forEach(promo => {
                        const isUsed = promo.is_used || false;
                        const promoCard = document.createElement('div');
                        promoCard.className = 'promo-card';
                        
                        // –°—Ç–∏–ª–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ (–∫—Ä–∞—Å–Ω—ã–µ)
                        if (isUsed) {
                            promoCard.style.cssText = 'border: 1px solid var(--text-color); border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: not-allowed; transition: all 0.3s; background: #fff; opacity: 0.7;';
                        } else {
                            promoCard.style.cssText = 'border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s; background: #fff;';
                        }
                        
                        promoCard.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; font-size: 16px; color: ${isUsed ? 'var(--text-color)' : '#2c3e50'}; margin-bottom: 4px;">${promo.promo_code}</div>
                                    <div style="font-size: 14px; color: ${isUsed ? '#c0392b' : '#7f8c8d'};">
                                        ${isUsed ? '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω' : (promo.promo_description || '–°–∫–∏–¥–∫–∞ ' + promo.discount + '%')}
                                    </div>
                                    ${promo.end_date ? '<div style="font-size: 12px; color: #95a5a6; margin-top: 4px;">–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: ' + new Date(promo.end_date).toLocaleDateString('ru-RU') + '</div>' : ''}
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="font-size: 18px; font-weight: bold; color: ${isUsed ? 'var(--text-color)' : 'var(--text-color)'};">-${promo.discount}%</div>
                                    ${isUsed ? 
                                        '<button type="button" disabled style="padding: 6px 12px; background: #95a5a6; color: #fff; border: none; border-radius: 4px; cursor: not-allowed; font-size: 12px; font-weight: 600; white-space: nowrap; opacity: 0.6;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω</button>' :
                                        '<button type="button" class="copy-promo-btn" data-promo-code="' + promo.promo_code + '" style="padding: 6px 12px; background: var(--text-color); color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; white-space: nowrap;">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>'
                                    }
                                </div>
                            </div>
                        `;
                        
                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å" —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
                        if (!isUsed) {
                            const copyBtn = promoCard.querySelector('.copy-promo-btn');
                            if (copyBtn) {
                                copyBtn.addEventListener('click', function(e) {
                                    try {
                                        if (e && e.stopPropagation) {
                                    e.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
                                        }
                                        if (!this) return;
                                    const promoCode = this.getAttribute('data-promo-code');
                                        if (!promoCode) return;
                                    const promoInput = document.getElementById('promo_code_input');
                                    if (promoInput) {
                                        promoInput.value = promoCode;
                                        // –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
                                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                        navigator.clipboard.writeText(promoCode).then(() => {
                                                    if (this) {
                                                        const originalText = this.textContent || '';
                                            this.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                                                        if (this.style) {
                                            this.style.background = 'var(--btn-bg)';
                                                        }
                                            setTimeout(() => {
                                                            if (this) {
                                                this.textContent = originalText;
                                                                if (this.style) {
                                                this.style.background = 'var(--text-color)';
                                                                }
                                                            }
                                            }, 2000);
                                                    }
                                        }).catch(() => {
                                            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å, –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ
                                                    if (promoInput && promoInput.select) {
                                            promoInput.select();
                                                        if (promoInput.setSelectionRange) {
                                            promoInput.setSelectionRange(0, 99999);
                                                        }
                                                    }
                                        });
                                            }
                                    }
                                    } catch (err) {
                                        console.error('–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∫–Ω–æ–ø–∫–∏ "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å":', err);
                                    }
                                });
                            }
                        }
                        
                        listEl.appendChild(promoCard);
                    });
                }
            } else {
                if (listEl) listEl.style.display = 'none';
                if (emptyEl) emptyEl.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤:', error);
            if (loadingEl) loadingEl.style.display = 'none';
            if (listEl) listEl.style.display = 'none';
            if (emptyEl) {
                emptyEl.style.display = 'block';
                emptyEl.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤';
            }
        });
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –≤ loadAvailablePromotions:', e);
    }
    }
    
    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
    function applyPromoCode(promoCode) {
        try {
        const message = document.getElementById('promo_message');
            const subtotalEl = document.getElementById('subtotal-value');
            if (!subtotalEl) return;
            const cartTotal = parseFloat((subtotalEl.textContent || '0').replace(/\s/g, '').replace('‚ÇΩ', '')) || 0;
        
        if (!promoCode || !promoCode.trim()) {
            if (message) {
                message.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥';
                message.style.color = 'var(--text-color)';
                message.style.display = 'block';
            }
            return;
        }
        
        fetch('/api/validate-promo/', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                promo_code: promoCode.toUpperCase().trim(),
                cart_total: cartTotal
            })
        })
        .then(r => {
            if (!r.ok) {
                return r.json().then(data => {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞');
                });
            }
            return r.json();
        })
        .then(data => {
            if (data.success) {
                const discountItem = document.getElementById('discount-item');
                const discountValue = document.getElementById('discount-value');
                const vatValue = document.getElementById('vat-value');
                const totalValue = document.getElementById('total-value');
                if (discountItem) discountItem.style.display = 'flex';
                if (discountValue) discountValue.textContent = formatAmount(parseFloat(data.discount));
                if (vatValue) vatValue.textContent = formatAmount(parseFloat(data.vat_amount));
                if (totalValue) totalValue.textContent = formatAmount(parseFloat(data.total));
                if (message) {
                    message.textContent = '–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω (' + data.discount_percent + '%)';
                    message.style.color = 'var(--text-color)';
                    message.style.display = 'block';
                }
                // –î–æ—Å—Ç–∞–≤–∫–∞ –¥–ª—è –æ–Ω–ª–∞–π–Ω-–∫—É—Ä—Å–æ–≤ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ‚Äî –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º ¬´–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è¬ª
                updateSubmitButton();
            } else {
                if (message) {
                    message.textContent = data.error || '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –ø—Ä–∏–Ω—è—Ç';
                    message.style.color = 'var(--text-color)';
                    message.style.display = 'block';
                }
            }
        })
        .catch(error => {
            if (message) {
                message.textContent = error.message || '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞';
                message.style.color = 'var(--text-color)';
                message.style.display = 'block';
            }
        });
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –≤ applyPromoCode:', e);
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å" –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
    const applyPromoBtn = document.getElementById('apply_promo_btn');
    const promoCodeInput = document.getElementById('promo_code_input');
    if (applyPromoBtn && promoCodeInput) {
        applyPromoBtn.addEventListener('click', function() {
            const promoCode = promoCodeInput.value.trim().toUpperCase();
            if (!promoCode) {
                const message = document.getElementById('promo_message');
                if (message) {
                    message.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥';
                    message.style.color = 'var(--text-color)';
                    message.style.display = 'block';
                }
                return;
            }
            applyPromoCode(promoCode);
        });
        
        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ Enter
        promoCodeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                applyPromoBtn.click();
            }
        });
    }
    

// –¢–µ—Å—Ç: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –∏ —Ñ–æ—Ä–º–∞ —Ä–∞–±–æ—Ç–∞—é—Ç
setTimeout(function() {
    const form = document.getElementById('checkout-form');
    const button = document.querySelector('.submit-button');
    console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º—ã –∏ –∫–Ω–æ–ø–∫–∏:');
    console.log('- –§–æ—Ä–º–∞ –Ω–∞–π–¥–µ–Ω–∞:', !!form);
    console.log('- –ö–Ω–æ–ø–∫–∞ –Ω–∞–π–¥–µ–Ω–∞:', !!button);
    console.log('- –ö–Ω–æ–ø–∫–∞ disabled:', button ? button.disabled : 'N/A');
    console.log('- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º—ã:', form ? form.getAttribute('data-handler-initialized') || form.getAttribute('data-backup-handler') : 'N/A');
}, 1000);
 
// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–µ–π –∫–∞—Ä—Ç—ã
['card_number'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('input', function(e) {
            let v = e.target.value.replace(/\s/g, '');
            e.target.value = (v.match(/.{1,4}/g)?.join(' ') || v);
        });
    }
});

['expiry_month'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('input', function(e) {
            let v = e.target.value.replace(/\D/g, '');
            if (v.length > 2) v = v.slice(0, 2);
            if (v.length === 2 && parseInt(v) > 12) v = '12';
            e.target.value = v;
        });
    }
});

['expiry_year'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('input', function(e) {
            let v = e.target.value.replace(/\D/g, '');
            if (v.length > 4) v = v.slice(0, 4);
            e.target.value = v;
        });
    }
});
</script>
{% endblock %}




